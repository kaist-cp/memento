# Setup a cache to cache job parts between jobs to ensure faster builds
cache:
    key: "$CI_JOB_NAME"
    untracked: true
    paths:
    - $HOME/.cargo/
    - target/

# Set any required environment variables here
variables:
  RUST_BACKTRACE: "FULL"

image: "rust:latest"

stages:
- install
- test

install:
  stage: install
  script:
    - rustup default stable

check:
  stage: test
  before_script:
    - rustup component add rustfmt clippy
    - cargo install cargo-audit
  script:
    - cargo check --verbose
    - cargo fmt -- --check
    - cargo clippy -- -D warnings
    - cargo audit

debug:
  stage: test
  script:
    # 테스트시 Op들을 정적할당하기 위해 Stack 크기가 커야함
    - RUST_MIN_STACK=1073741824 cargo test

release:
  stage: test
  script:
    - RUST_MIN_STACK=1073741824 cargo test --release
