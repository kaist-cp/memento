# Setup a cache to cache job parts between jobs to ensure faster builds
cache:
    key: "$CI_JOB_NAME"
    untracked: true
    paths:
    - $HOME/.cargo/
    - target/

# Set any required environment variables here
variables:
  RUST_BACKTRACE: "FULL"

image: "rust:latest"

stages:
- test

check:
  stage: test
  before_script:
    - rustup component add rustfmt clippy
    - cargo install cargo-audit
  script:
    - cargo check --verbose
    - cargo fmt -- --check
    # - cargo clippy -- -D warnings
    # - cargo audit # TODO: chrono 때문에 통과 안 돼서 잠시 commenting (issue: https://github.com/chronotope/chrono/pull/578#issuecomment-945604623)

debug:
  stage: test
  script:
    # pool layout 바뀔 때마다 기존 파일을 직접 제거해야하는 불편함 해소
    - rm -f test/*

    # `RUST_MIN_STACK`: 테스트시 Op들을 정적할당하기 위해 Stack 크기가 커야함
    # `no_persist`: ci 서버는 clflush 등의 persist instruction 안됨 ("illegal instruction")
    - RUST_MIN_STACK=5073741824 cargo test --features no_persist

    # idempotency 테스트를 위해 한 번 더 실행하기
    # - RUST_MIN_STACK=5073741824 cargo test --features no_persist # TODO: test에 rec run 적용해서 다시 오픈

release:
  stage: test
  script:
    - rm -f test/*
    - RUST_MIN_STACK=5073741824 cargo test --release --features no_persist
    - RUST_MIN_STACK=5073741824 cargo test --release --features no_persist
